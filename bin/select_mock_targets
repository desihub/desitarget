#!/usr/bin/env python
import desitarget.mock.build


import os
import argparse
import yaml

parser = argparse.ArgumentParser()
parser.add_argument('--config','-c',default='input.yaml')
parser.add_argument("--output_dir", "-O", help="Path to write the outputs", type=str, default="./")
parser.add_argument("--realtargets", "-r", help="Path to real target catalog", type=str)
args = parser.parse_args()

if not os.path.exists(args.config):
    raise Exception('No config file {} '.format(args.config))

print('According to config in:    {}'.format(args.config))
print('')

# Read parameters from yaml
with open(args.config,'r') as pfile:
    params = yaml.load(pfile)

if args.realtargets is not None:
    from astropy.io import fits
    print('Loading real targets from {}'.format(args.realtargets))
    realtargets = fits.getdata(args.realtargets)
else:
    realtargets = None

# Construct Targets and Truth files
desitarget.mock.build.targets_truth(params, args.output_dir, realtargets=realtargets)

print('done!')

